<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SpiritCHAT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: rgba(211, 211, 211, 0.2);
            font-family: Times New Roman, sans-serif;
            {#overflow: hidden;#}
        }

        .left-panel {
            background-color: #FFFFFF;
            border-right: 1px solid #ccc;
            min-height: 100vh;
            padding: 20px;
        }

        .right-panel {
            /* Изменим цвет фона на бежевый */
            background-color: white;
            height: 100vh;
            padding: 20px;
        }

        .scrollable-content {
            /* Создаем прокручиваемый список */
            max-height: 85vh;
            overflow-y: auto;
        }

        .profile-pic {
            border-radius: 50%;
        }

        .small-title {
            font-size: 0.9em;
        }

        .small-header {
            font-size: 1.2em;
        }

        .btn-custom {
            background-color: #075E54;
            color: white;
        }

        .btn-custom:hover {
            background-color: #128C7E;
        }

        .chat-item h3, .channel-item h3 {
            font-size: 1.2em;
            text-transform: none;
        }

        .flex-container {
            display: flex;
            align-items: center;
        }

        .flex-grow {
            flex-grow: 1;
        }


        .logout-button {
            background-color: #075E54 !important;
            color: white !important;
        }


        .profile-picture {
            border-radius: 50%;
        }

        .profile-picture-container {
            margin-right: 20px; /* Увеличено с 10px до 20px */
        }

        .dialog-actions {
            margin-left: auto;
        }

        .button {
            display: flex;
            height: 53px;
            width: 470px;
            padding: 0px 24px;
            justify-content: center;
            align-items: center;
            align-self: stretch;
            background-color: #2A88B9;
        }

        .button:hover {
            background-color: #2A88B9;
        }

        .my_nickname {
            font-family: Roboto, serif;
            font-size: 14px;
            font-style: normal;
            font-weight: 400;
            line-height: 16px;
        }

        .status {
            font-family: Roboto, serif;
            font-size: 12px;
            font-style: normal;
            font-weight: 400;
            line-height: 16px;
            color: #928F8F;
        }

        .search-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 16px;
        }

        .search-input {
            flex-grow: 1;
            margin-right: 10px;
        }

        .search-icons img {
            margin-right: 16px;
            width: 30px;
            height: 30px;
        }

        .scrollable-content {
            overflow: hidden;
        }

        /* Добавляем пользовательскую прокрутку */
        .scrollable-content {
            overflow-y: scroll;
            scrollbar-width: thin; /* для Firefox */
            scrollbar-color: transparent transparent; /* для Firefox */
        }

        /* Стили для Webkit (Chrome, Safari) */
        .scrollable-content::-webkit-scrollbar {
            width: 12px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: transparent;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background-color: transparent;
        }
        .username {
            font-family: Roboto, serif;
            font-size: 14px;
            font-style: normal;
            font-weight: 400;
            line-height: 16px;
        }

        .last_message {
            font-family: Roboto, serif;
            font-size: 12px;
            font-style: normal;
            font-weight: 400;
            line-height: 16px;
            color: #928F8F;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Left Panel -->
        <div class="col-md-3 left-panel pb-0" style="min-width: 429px;">
            <!-- Profile Section -->
            <div class="d-flex align-items-center mb-4">
                <img src="/profile/picture/{{ current_user.phone_number }}" alt="Profile picture" class="profile-pic"
                     width="50" height="50">
                <div class="ms-3">
                    <h1 class="my_nickname">{{ current_user.nickname }}</h1>
                    <small id="current-user-nickname" class="status">{{ current_user.status }}</small>
                </div>

            </div>
            <hr>
            <div class="search-container">
                <form action="/home" method="get" class="search-input">
                    <input type="text" class="form-control search-input"
                           style="background-color: #EBEBEB; color: #928F8F; border-radius: 8px; font-size: 12px;"
                           placeholder="Поиск">
                </form>
                <img src="../static/users.svg" alt="User Icon" id="contactImage" style="cursor: pointer;">
                <img src="../static/menu.svg" alt="Email Icon" id="menuImage" style="cursor: pointer;">

                <div class="ms-auto">
                    <div class="btn-group">
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/profile">Личный профиль</a></li>
                            <li><a class="dropdown-item create-chat-link" href="#">Создать новую группу</a></li>
                            {#                            <li><a class="dropdown-item" href="/create_channel">Создать новый канал</a></li>#}
                            <li><a class="dropdown-item create-dialog-link" href="/create_dialog">Создать новый
                                диалог</a></li>
                            {#                            <li><a class="dropdown-item" href="/favorites">Избранное</a></li>#}
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="/logout">Выйти из аккаунта</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Блок для отображения результатов поиска -->
            {% if search_query %}
                <h2 class="small-header">Результаты поиска</h2>
                <div class="search-results-list">
                    {% for chat in search_results_chats %}
                        <div class="container border-bottom mb-2">
                            <div class="search-results-item small-title">
                                <h3>{{ chat['chat_name'] }}</h3>
                                <p>Владелец: {{ chat['owner_phone_number'] }}</p>
                                <a href="/chat/{{ chat['id'] }}">Перейти в чат</a>
                            </div>
                        </div>
                    {% endfor %}
                    {% for channel in search_results_channels %}
                        <div class="container border-bottom mb-2">
                            <div class="search-results-item small-title">
                                <h3>{{ channel['name'] }}</h3>
                                <p>Владелец: {{ channel['owner_phone_number'] }}</p>
                                <a href="/channels/{{ channel['id'] }}">Перейти в канал</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="scrollable-content" style="padding-bottom: 55px;">
                <div class="dialogs-list">
                    {% for dialog in dialogs %}
                        <div class="container border-bottom mb-2 pb-2 mt-1 clickable-dialog flex-container"
                             data-dialog-id="{{ dialog.id }}">
                            <!-- Фото собеседника -->
                            <div class="profile-picture-container">
                                <img src="/profile/picture/{{ dialog.interlocutor_phone_number }}"
                                     alt="Interlocutor's profile picture" width="50" height="50"
                                     class="profile-picture">
                            </div>
                            <!-- Информация о диалоге -->
                            <div class="dialogs-item small-title flex-grow">
                                <div>
                                    <strong class="username">{{ dialog.user_fio }}</strong>
                                </div>
                                <div>
                                    <!-- Последнее сообщение -->
                                    {% if '[[FILE]]' in dialog.last_message %}
                                        {% set file_message_parts = dialog.last_message.split('[[FILE]]') %}
                                        {% if ', ' in file_message_parts[1] %}
                                            {% set file_info_parts = file_message_parts[1].replace('[[/FILE]]', '').split(', ') %}
                                            <small class="last_message">{{ file_info_parts[1].split(': ')[1] }}</small>
                                        {% endif %}
                                    {% else %}
                                        {% set short_message = dialog.last_message[:25] + "..." if dialog.last_message|length >
                                25 else dialog.last_message %}
                                        <small class="last_message">{{ short_message }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Действия с диалогом -->
                            {#                            <div class="dialog-actions">#}
                            {#                                <form action="/dialogs/{{ dialog['id'] }}/delete_post" method="post">#}
                            {#                                    <input type="submit" value="Удалить">#}
                            {#                                </form>#}
                            {#                            </div>#}
                        </div>
                    {% endfor %}
                </div>

                <div class="chat-list">
                    {% for chat in chats %}
                        <div class="container border-bottom mb-2 pb-2 mt-1 clickable-chat flex-container"
                             data-chat-id="{{ chat.id }}">
                            <!-- Фото чата -->
                            <div class="profile-picture-container">
                                <img src="/chat/picture/{{ chat.id }}" alt="Chat picture" width="50" height="50"
                                     class="profile-picture">
                            </div>
                            <!-- Информация о чате -->
                            <div class="chat-item small-title flex-grow" style="display: flex; flex-direction: column;">
                                <div style="flex: 1;">
                                    <strong class="username">{{ chat['chat_name'] }}</strong>
                                    <!-- Название группы жирным текстом -->
                                    {% if chat['id'] in left_chats %}
                                        <p>Вы покинули чат</p>
                                    {% endif %}
                                </div>
                                <div style="flex: 1;">
                                    {% if '[[FILE]]' in chat['last_message'] %}
                                        {% set file_message_parts = chat['last_message'].split('[[FILE]]') %}
                                        {% if ', ' in file_message_parts[1] %}
                                            {% set file_info_parts = file_message_parts[1].replace('[[/FILE]]', '').split(', ') %}
                                            <p class="last_message">
                                                <strong class="last_message">{{ chat['last_message_sender_phone'] }}</strong class="last_message">: {{ file_info_parts[1].split(': ')[1] }}
                                            </p>
                                            <!-- Никнейм пользователя жирным текстом -->
                                        {% endif %}
                                    {% else %}
                                        <p>
                                            <strong class="last_message" style="font-weight: 500">{{ chat['last_message_sender_phone'] }}</strong>
                                            <strong class="last_message">: {{ chat['last_message'] }}</strong>
                                        </p> <!-- Никнейм пользователя жирным текстом -->
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                {#                <h2 class="small-header">Ваши каналы</h2>#}
                {#                <div class="channel-list">#}
                {#                    {% for channel in channels %}#}
                {#                        <div class="container border-bottom mb-2">#}
                {#                            <div class="channel-item small-title">#}
                {#                                <h3>{{ channel['name'] }}</h3>#}
                {#                                <p>Владелец: {{ channel['owner_phone_number'] }}</p>#}
                {#                                {% if channel['owner_phone_number'] == current_user.phone_number and#}
                {#                            channel['last_owner_message'] %}#}
                {#                                    <p>{{ channel['last_owner_message'] }}#}
                {#                                        - {{ channel['last_owner_message_timestamp'] }}</p>#}
                {#                                    {% if channel['last_owner_message_file'] %}#}
                {#                                        <a href="/files/{{ channel['last_owner_message_file'] }}">Посмотреть#}
                {#                                            прикрепленный файл</a>#}
                {#                                    {% endif %}#}
                {#                                {% elif channel['last_message'] %}#}
                {#                                    <p>{{ channel['last_message'] }} - {{ channel['last_message_timestamp'] }}</p>#}
                {#                                    {% if channel['last_message_file'] %}#}
                {#                                        <a href="/files/{{ channel['last_message_file'] }}">Посмотреть прикрепленный#}
                {#                                            файл</a>#}
                {#                                    {% endif %}#}
                {#                                {% endif %}#}
                {#                                <a href="/channels/{{ channel['id'] }}">Перейти в канал</a>#}
                {#                                {% if channel['owner_phone_number'] == current_user.phone_number %}#}
                {#                                    <form action="/channels/{{ channel['id'] }}/delete" method="post">#}
                {#                                        <input type="submit" value="Удалить канал">#}
                {#                                    </form>#}
                {#                                {% endif %}#}
                {#                            </div>#}
                {#                        </div>#}
                {#                    {% endfor %}#}
                {#                </div>#}

            </div>
        </div>
        <!-- Правая панель -->
        <div class="col-md-8 right-panel" style="width: 1490px">
            <!-- добавленные стили для "шторки" -->
            <style>
                .drawer {
                    position: fixed;
                    top: 0;
                    right: -400px;
                    width: 400px;
                    height: 100vh;
                    background-color: #ECE5DD;
                    border-left: 1px solid #ce8334;
                    padding: 15px;
                    transition: right 0.3s ease;
                }

                .drawer.open {
                    right: 0;
                }
            </style>
            <div id="dialog-panel">
                <div id="dialog-container">
                    <ul class="list-group"></ul>
                    <div id="dialog-history">

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>

    $(document).ready(function () {
        var dropdownVisible = false;

        // Скрываем dropdown при загрузке страницы
        $(".dropdown-menu").hide();

        // Обработчик события клика на изображении


        // Закрываем dropdown при клике вне его области
        // $(document).mouseup(function (e) {
        // var container = $(".dropdown-menu");
        //if (!container.is(e.target) && container.has(e.target).length === 0) {
        //  container.hide();
        //dropdownVisible = false;
        //}
        //});

        // Закрываем dropdown при повторном клике на изображение
        $("#menuImage").on("click", function () {
            if (dropdownVisible) {
                $(".dropdown-menu").hide();
                dropdownVisible = false;
            } else {
                $(".dropdown-menu").toggle();
                dropdownVisible = true;
            }
        });

        $("#contactImage").on("click", function () {
            window.location.href = '/contacts';
        });
    });


    var ws;

    function editMessage(messageIdStr) {
        console.log("Editing message with ID:", messageIdStr);
        const messageId = parseInt(messageIdStr, 10);
        if (isNaN(messageId)) {
            console.error(`Invalid messageId: ${messageIdStr}`);
            return;
        }

        let messageElement = document.querySelector(`[data-message-id="${messageId}"] .message-content`) ||
            document.querySelector(`[data-message-id="${messageId}"] .message-self`);

        if (!messageElement) {
            console.error("Message element not found for ID:", messageId);
            return;
        }

        // Извлечение только текста из элемента сообщения
        let messageText = extractMessageText(messageElement);

        // Обновление формы ввода сообщения
        const textArea = document.querySelector('textarea[name="message"]');
        if (textArea) {
            textArea.value = messageText;
            const submitButton = document.querySelector('#message-form button[type="submit"]');
            if (submitButton) {
                submitButton.textContent = 'Сохранить';
                submitButton.onclick = function (e) {
                    e.preventDefault();
                    saveEditedMessage(messageId);
                };
            } else {
                console.error('Submit button not found');
            }
        } else {
            console.error('Textarea for message not found');
        }
    }

    function extractMessageText(messageElement) {
        let messageText = '';
        Array.from(messageElement.childNodes).forEach(node => {
            if (node.nodeType === Node.TEXT_NODE) {
                messageText += node.textContent;
            } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName !== 'BUTTON' && node.tagName !== 'SPAN') {
                // Игнорируем текст из специальных элементов (кнопки, спаны с метками)
                if (!node.classList.contains('message-dropdown') && !node.classList.contains('edited-mark')) {
                    messageText += node.textContent;
                }
            }
        });

        // Удаление служебных слов, фраз и "None"
        const serviceWords = ["Переслать", "Изменить", "Удалить сообщение", "Отправлено:", "None"];
        serviceWords.forEach(word => {
            messageText = messageText.replace(new RegExp(word, 'g'), '');
        });

        // Удаление даты (новый формат: 2023-11-22 11:53:32)
        messageText = messageText.replace(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/g, '');

        return messageText.trim();
    }


    function saveEditedMessage(messageId) {
        const newMessageText = document.querySelector('textarea[name="message"]').value;
        const currentDate = new Date().toLocaleString();

        ws.send(JSON.stringify({
            action: 'edit_message',
            message_id: messageId,
            new_text: newMessageText
        }));

        let messageElement = document.querySelector(`[data-message-id="${messageId}"] .message-content`) ||
            document.querySelector(`[data-message-id="${messageId}"] .message-self`);

        if (messageElement) {
            const dropdownMenu = messageElement.querySelector('.message-dropdown') ?
                messageElement.querySelector('.message-dropdown').cloneNode(true) :
                null;

            messageElement.innerHTML = newMessageText;

            const editedMark = document.createElement('span');
            editedMark.className = 'edited-mark';
            editedMark.innerHTML = ` <br>Изменено: ${currentDate}`;
            messageElement.appendChild(editedMark);

            if (dropdownMenu) {
                const dropdownIcon = dropdownMenu.querySelector('.message-options-icon');
                if (dropdownIcon) {
                    dropdownIcon.onclick = function (event) {
                        toggleDropdownMenu(event);
                    };
                }

                // Обновляем обработчики событий для кнопок в выпадающем меню
                const deleteButton = dropdownMenu.querySelector('.dropdown-item:first-child');
                const editButton = dropdownMenu.querySelector('.dropdown-item:nth-child(2)');

                if (deleteButton) {
                    deleteButton.onclick = function () {
                        deleteMessage(messageId.toString());
                    };
                }

                if (editButton) {
                    editButton.onclick = function () {
                        editMessage(messageId.toString());
                    };
                }

                messageElement.appendChild(dropdownMenu);
            }
        }

        const submitButton = document.querySelector('#message-form button[type="submit"]');
        submitButton.textContent = 'Отправить';
        submitButton.onclick = null;
        document.querySelector('textarea[name="message"]').value = '';
    }


    // Инициализация кода для dialogs.html
    function initializeDialogJS(dialogId, currentUserId) {  // Добавлен параметр currentUserId
        const cookie = document.cookie.split('; ').find(row => row.startsWith('access_token='));
        const access_token = cookie ? cookie.split('=')[1] : null;
        ws = new WebSocket(`ws://127.0.0.1:8000/ws/dialogs/${dialogId}/`);

        ws.onopen = function (event) {
            console.log("WebSocket connection opened.", event);
            ws.send(JSON.stringify({"action": "init_connection", "dialog_id": dialogId, "access_token": access_token}));
        };

        // Автоматическая прокрутка к последнему сообщению
        const messagesContainer = document.querySelector('.messages-container');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Обработчик события нажатия клавиши в текстовом поле формы
        const textArea = document.querySelector('textarea[name="message"]');
        textArea.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // предотвращаем перевод строки
                document.getElementById('message-form').dispatchEvent(new Event('submit'));
            }
        });

        // Функция отправки сообщения
        const form = document.getElementById('message-form');
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(form);

            fetch(`/dialogs/${dialogId}/send_message`, {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to send message');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.message_id) {
                        const messagesList = document.querySelector('.list-group');
                        const newMessage = document.createElement('li');
                        newMessage.className = "message-item user";
                        newMessage.dataset.messageId = data.message_id;

                        const messageContent = document.createElement('div');
                        messageContent.className = "message-content";
                        messageContent.dataset.messageId = data.message_id;

                        // Создаем и добавляем текстовый узел для текста сообщения
                        const messageTextNode = document.createTextNode(data.message_text);
                        messageContent.appendChild(messageTextNode);

                        newMessage.appendChild(messageContent);
                        messagesList.appendChild(newMessage);
                    }

                    // Очищаем поля ввода после отправки
                    form.querySelector('textarea[name="message"]').value = '';
                    const fileInput = form.querySelector('input[type="file"]');
                    if (fileInput) {
                        fileInput.value = '';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });


        ws.onmessage = function (event) {
            let messageData;
            try {
                messageData = JSON.parse(event.data);
            } catch (e) {
                console.error("Invalid JSON", e);
                return;
            }

            const action = messageData.action;

            if (action === 'new_token') {
                document.cookie = "access_token=" + messageData.token;
            } else if (action === 'message_deleted') {
                const messageId = messageData.message_id;
                console.log("Attempting to delete message with ID:", messageId);
                const messageElement = document.querySelector(`.message-item[data-message-id="${messageId}"], .message-self[data-message-id="${messageId}"]`);
                if (messageElement) {
                    console.log(`Deleting message with id: ${messageId}`);
                    messageElement.remove();
                } else {
                    console.warn(`Message with id: ${messageId} not found for deletion`);
                }
            } else if (action === 'message_updated') {
                const messageId = messageData.message_id;
                const newMessageText = messageData.new_text;
                const editTimestamp = messageData.edit_timestamp; // Получаем время редактирования

                let messageElement = document.querySelector(`.message-item[data-message-id="${messageId}"] .message-content`) ||
                    document.querySelector(`.message-self[data-message-id="${messageId}"]`);

                if (messageElement) {
                    messageElement.innerHTML = newMessageText;

                    // Добавление метки "Изменено"
                    if (editTimestamp) {
                        const editedMark = document.createElement('span');
                        editedMark.className = 'edited-mark';
                        editedMark.textContent = ` Изменено: ${new Date(editTimestamp).toLocaleString()}`;
                        messageElement.appendChild(editedMark);
                    }

                    // Добавление выпадающего меню (если оно есть)
                    const dropdownMenu = messageElement.querySelector('.message-dropdown') ?
                        messageElement.querySelector('.message-dropdown').cloneNode(true) : null;
                    if (dropdownMenu) {
                        messageElement.appendChild(dropdownMenu);
                    }
                }
            } else if (messageData.message && messageData.message.sender_id) {
                const currentUserId = "{{ current_user.id }}";
                const newMessage = document.createElement('li');
                newMessage.className = messageData.message.sender_id === parseInt(currentUserId) ? "message-item user" : "message-item";
                newMessage.dataset.messageId = String(messageData.message.message_id);

                const messageContent = document.createElement('div');
                messageContent.className = messageData.message.sender_id === parseInt(currentUserId) ? "message-self" : "message-content";

                const senderNickname = messageData.message.sender_nickname || "";
                const rawMessage = messageData.message.message;

                if (senderNickname) {
                    const senderElement = document.createElement('strong');
                    senderElement.innerText = senderNickname + ":";
                    messageContent.appendChild(senderElement);
                }

                const messageTextElement = document.createElement('div');
                if (rawMessage.includes('[[FILE]]') && rawMessage.includes('[[/FILE]]')) {
                    const [text, fileInfo] = rawMessage.split('[[FILE]]');
                    const cleanedFileInfo = fileInfo.replace('[[/FILE]]', '');
                    const [fileIdInfo, fileNameInfo] = cleanedFileInfo.split(', ');
                    const fileId = fileIdInfo.split(': ')[1];
                    const fileName = fileNameInfo.split(': ')[1];

                    messageTextElement.appendChild(document.createTextNode(" " + text));
                    messageContent.appendChild(messageTextElement);

                    const fileLink = document.createElement('div');
                    const fileAnchor = document.createElement('a');
                    fileAnchor.href = `/files/${fileId}`;
                    fileAnchor.innerText = fileName;
                    fileLink.appendChild(fileAnchor);
                    messageContent.appendChild(fileLink);
                } else {
                    messageTextElement.appendChild(document.createTextNode(" " + rawMessage));
                    messageContent.appendChild(messageTextElement);
                }

                const timeElement = document.createElement('div');
                timeElement.appendChild(document.createTextNode("Отправлено: " + (messageData.message.timestamp || "")));
                messageContent.appendChild(timeElement);

                if (messageData.message.sender_id === parseInt(currentUserId)) {
                    const dropdown = document.createElement('div');
                    dropdown.className = 'message-dropdown';

                    const dropdownIcon = document.createElement('img');
                    dropdownIcon.src = '/static/downarrow.png';
                    dropdownIcon.alt = 'Options';
                    dropdownIcon.className = 'message-options-icon';
                    dropdownIcon.onclick = function (event) {
                        toggleDropdownMenu(event);
                    };

                    const dropdownContent = document.createElement('div');
                    dropdownContent.className = 'message-options';
                    dropdownContent.style.display = 'none';

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'dropdown-item';
                    deleteButton.textContent = 'Удалить сообщение';
                    deleteButton.onclick = function () {
                        deleteMessage(messageData.message.message_id.toString());
                    };
                    dropdownContent.appendChild(deleteButton);

                    const editButton = document.createElement('button');
                    editButton.className = 'dropdown-item';
                    editButton.textContent = 'Изменить';
                    editButton.onclick = function () {
                        editMessage(messageData.message.message_id.toString());
                    };
                    dropdownContent.appendChild(editButton);

                    const forwardButton = document.createElement('button');
                    forwardButton.className = 'dropdown-item';
                    forwardButton.textContent = 'Переслать';
                    dropdownContent.appendChild(forwardButton);

                    dropdown.appendChild(dropdownIcon);
                    dropdown.appendChild(dropdownContent);
                    messageContent.appendChild(dropdown);
                }

                newMessage.appendChild(messageContent);
                const messagesList = document.querySelector('.list-group');
                messagesList.appendChild(newMessage);

                setTimeout(() => {
                    messagesList.scrollTop = messagesList.scrollHeight;
                }, 100);
            }
        };
    }


    // Функции для работы с сообщениями
    function deleteMessage(messageIdStr) {
        console.log("Deleting message with ID:", messageIdStr); // Для отладки
        const messageId = parseInt(messageIdStr, 10);
        if (isNaN(messageId)) {
            console.error(`Invalid messageId: ${messageIdStr}`);
            return;
        }

        const deleteRequest = JSON.stringify({action: 'delete_message', message_id: messageId});
        ws.send(deleteRequest);
    }


    // Добавляем функцию toggleDropdownMenu
    function toggleDropdownMenu(event) {
        const dropdownMenu = event.target.nextElementSibling;
        const isDisplayed = dropdownMenu.style.display === 'block';
        // Закрыть все открытые выпадающие меню перед открытием нового
        const allDropdowns = document.querySelectorAll('.message-options');
        allDropdowns.forEach(function (menu) {
            menu.style.display = 'none';
        });
        // Переключить состояние выбранного выпадающего списка
        dropdownMenu.style.display = isDisplayed ? 'none' : 'block';
    }

    document.addEventListener('click', function (event) {
        const withinDropdown = event.target.closest('.message-dropdown');
        if (!withinDropdown) {
            const dropdowns = document.querySelectorAll('.message-options');
            dropdowns.forEach(function (dropdown) {
                dropdown.style.display = 'none';
            });
        }
    });


    // Загрузка dialogs.html в правую панель
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.clickable-dialog').forEach(function (container) {
            container.addEventListener('click', function (event) {
                // Не выполняем действие, если клик был по кнопке "Перейти в диалог"
                if (event.target.classList.contains('load-dialog')) return;

                const dialogId = event.currentTarget.getAttribute('data-dialog-id');
                const currentUserId = "{{ current_user.id }}"; // Получение ID текущего пользователя
                console.log("Current User ID:", currentUserId); // Логирование для отладки

                fetch(`/dialogs/${dialogId}`)
                    .then(response => response.text())
                    .then(html => {
                        document.querySelector('#dialog-panel').innerHTML = html;
                        initializeDialogJS(dialogId, currentUserId); // Передаем ID диалога и ID пользователя
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                    });
            });
        });
    });


    // Инициализация кода для create_dialog.html
    function initializeCreateDialogJS() {
        document.querySelectorAll('.start-dialog-form').forEach(function (form) {
            form.addEventListener('submit', function (event) {
                event.preventDefault();
                const userId = form.action.split('/').pop();

                fetch(`/create_dialog/${userId}`, {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        const dialogId = data.dialog_id;

                        // Загружаем содержимое dialogs.html в правую панель
                        fetch(`/dialogs/${dialogId}`)
                            .then(response => response.text())
                            .then(html => {
                                document.querySelector('.right-panel').innerHTML = html;
                                initializeDialogJS(dialogId);  // Инициализация JS для нового диалога
                            });
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                    });
            });
        });
    }

    // Добавление обработчика для кнопки "Создать новый диалог"
    document.addEventListener('DOMContentLoaded', function () {
        const createDialogLink = document.querySelector('.create-dialog-link');
        if (createDialogLink) {
            createDialogLink.addEventListener('click', function (event) {
                event.preventDefault();  // Отменяем стандартное поведение перехода по ссылке

                // Загружаем содержимое create_dialog.html
                fetch('/create_dialog')
                    .then(response => response.text())
                    .then(html => {
                        // Вставляем HTML в правую панель
                        document.querySelector('.right-panel').innerHTML = html;

                        // Инициализируем JS для create_dialog.html (если необходимо)
                        initializeCreateDialogJS();
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                    });
            });
        }
    });


    // Инициализация кода для dialogs.html
    // ... (ваш текущий код для dialogs)

    // Загрузка chat.html в правую панель
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.clickable-chat').forEach(function (container) {
            container.addEventListener('click', function (event) {
                if (event.target.classList.contains('load-chat')) return;

                const chatId = event.currentTarget.getAttribute('data-chat-id');
                fetch(`/chat/${chatId}`)
                    .then(response => response.text())
                    .then(html => {
                        document.querySelector('.right-panel').innerHTML = html;
                        initializeChatJS(chatId);
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                    });
            });
        });
    });

    // Инициализация кода для chat.html
    function initializeChatJS(chatId) {
        const cookie = document.cookie.split('; ').find(row => row.startsWith('access_token='));
        const access_token = cookie ? cookie.split('=')[1] : null;
        var ws = new WebSocket(`ws://127.0.0.1:8000/ws/chats/${chatId}/`);

        ws.onopen = function (event) {
            console.log("WebSocket connection opened.", event);
            ws.send(JSON.stringify({"action": "init_connection", "chat_id": chatId, "access_token": access_token}));
        };

        ws.onclose = function (event) {
            console.log("WebSocket connection closed:", event);
        };

        ws.onerror = function (error) {
            console.log(`WebSocket Error: ${error}`);
        };

        document.addEventListener('submit', function (event) {
            const form = event.target;
            if (form && form.action && form.action.endsWith(`/chats/${chatId}/send_message`)) {
                event.preventDefault();
                const formData = new FormData(form);
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Сообщение успешно отправлено. Message ID:', data.message.id);
                            const lastMessage = document.querySelector('.messages-list .message-item:last-child');
                            if (lastMessage) {
                                lastMessage.dataset.messageId = data.message.id;
                                console.log('Message ID установлен для нового сообщения:', data.message.id);
                            }
                            form.reset();
                        } else {
                            console.log('Ошибка при отправке сообщения:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при отправке формы:', error);
                    });
            }
        });

        document.querySelector('.right-panel').addEventListener('click', function (event) {
            // Закрытие всех открытых выпадающих списков
            document.querySelectorAll('.message-options').forEach(function (dropdown) {
                dropdown.style.display = 'none';
            });

            // Проверяем, был ли клик сделан по иконке выпадающего списка
            if (event.target.closest('.message-options-icon')) {
                const messageOptions = event.target.closest('.message-dropdown').querySelector('.message-options');
                messageOptions.style.display = messageOptions.style.display === 'none' ? 'block' : 'none';
            }

            // Обработчик клика для кнопки "Удалить сообщение"
            if (event.target.closest('.delete-message-button')) {
                const messageElement = event.target.closest('.message-item');
                const messageId = messageElement ? messageElement.dataset.messageId : null;
                console.log("ID сообщения перед удалением:", messageId); // Добавлено для отладки
                if (messageId) {
                    const messageIdNumber = parseInt(messageId, 10); // Уточняем, что это целое число
                    console.log("Отправка ID сообщения на сервер для удаления:", messageIdNumber); // Для отладки
                    ws.send(JSON.stringify({"action": "delete_message", "message_id": messageIdNumber}));
                } else {
                    console.error("Не удалось получить ID сообщения для удаления.");
                }
            }
        });
        document.querySelector('.messages-list').addEventListener('click', function (event) {
            // Проверяем, была ли нажата кнопка "Удалить сообщение"
            if (event.target.className === 'dropdown-item' && event.target.textContent === 'Удалить сообщение') {
                const messageElement = event.target.closest('.message-item');
                const messageId = messageElement ? messageElement.dataset.messageId : null;
                console.log("ID сообщения перед удалением:", messageId); // Для отладки
                if (messageId) {
                    const messageIdNumber = parseInt(messageId, 10);
                    console.log("Отправка ID сообщения на сервер для удаления:", messageIdNumber); // Для отладки
                    ws.send(JSON.stringify({"action": "delete_message", "message_id": messageIdNumber}));
                } else {
                    console.error("Не удалось получить ID сообщения для удаления.");
                }
            }
        });




        ws.onmessage = function (event) {
            let messageData;
            try {
                messageData = JSON.parse(event.data);
            } catch (e) {
                console.error("Invalid JSON", e);
                return;
            }

            const action = messageData.action;

            if (action === 'new_token') {
                document.cookie = "access_token=" + messageData.token;
            } else if (action === 'message_deleted') {
                // Обработка удаления сообщения
                const messageId = messageData.message_id;
                const messageElement = document.querySelector(`.message-item[data-message-id="${String(messageId)}"]`);
                if (messageElement) {
                    messageElement.remove();
                    console.log(`Сообщение с ID: ${messageId} удалено`);
                } else {
                    console.warn(`Message with id: ${messageId} not found for deletion`);
                }
            } else if (messageData.message && messageData.sender_phone_number) {
                // Обработка обычного сообщения
                const messagesList = document.getElementById('chat-history');

                const newMessageItem = document.createElement('div');
                newMessageItem.className = "message-item";
                newMessageItem.dataset.messageId = messageData.message.id;

                if (messageData.sender_nickname === "{{ current_user.nickname }}") {
                    newMessageItem.className += " user";
                }

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                const rawMessage = messageData.message;

                if (rawMessage.includes('[[FILE]]') && rawMessage.includes('[[/FILE]]')) {
                    const [text, fileInfo] = rawMessage.split('[[FILE]]');
                    const cleanedFileInfo = fileInfo.replace('[[/FILE]]', '');
                    const [fileIdInfo, fileNameInfo] = cleanedFileInfo.split(', ');
                    const fileId = fileIdInfo.split(': ')[1];
                    const fileName = fileNameInfo.split(': ')[1];

                    const messageTextElement = document.createElement('div');
                    messageTextElement.innerText = text;
                    messageContent.appendChild(messageTextElement);

                    const fileLink = document.createElement('div');
                    const fileAnchor = document.createElement('a');
                    fileAnchor.href = `/files/${fileId}`;
                    fileAnchor.innerText = fileName;
                    fileLink.appendChild(fileAnchor);
                    messageContent.appendChild(fileLink);
                } else {
                    const messageTextElement = document.createElement('div');
                    messageTextElement.innerText = rawMessage;
                    messageContent.appendChild(messageTextElement);
                }

                const timeElement = document.createElement('div');
                timeElement.innerText = "Отправлено: " + (messageData.timestamp || "undefined");
                messageContent.appendChild(timeElement);

                // Создание выпадающего списка
                const dropdown = document.createElement('div');
                dropdown.className = 'message-dropdown';
                const dropdownIcon = document.createElement('img');
                dropdownIcon.src = '/static/downarrow.png';
                dropdownIcon.alt = 'Options';
                dropdownIcon.className = 'message-options-icon';

                // Создание контента выпадающего списка
                const dropdownContent = document.createElement('div');
                dropdownContent.className = 'message-options';
                dropdownContent.style.display = 'none';

                // Кнопка "Удалить сообщение"
                const deleteButton = document.createElement('button');
                deleteButton.className = 'dropdown-item';
                deleteButton.textContent = 'Удалить сообщение';
                deleteButton.onclick = function () {
                    const messageIdToDelete = this.parentElement.parentElement.parentElement.dataset.messageId;
                    ws.send(JSON.stringify({"action": "delete_message", "message_id": messageIdToDelete}));
                };

                dropdownContent.appendChild(deleteButton);

                // Добавление других кнопок при необходимости

                dropdown.appendChild(dropdownIcon);
                dropdown.appendChild(dropdownContent);

                // Добавление выпадающего списка к сообщению
                messageContent.appendChild(dropdown);

                newMessageItem.appendChild(messageContent);
                messagesList.appendChild(newMessageItem);
            } else {
                console.warn('Неожиданный формат сообщения: ', messageData);
            }
        };


        // Обработчик для кнопки "Изменить фото"
        const changePhotoButton = document.getElementById('change-photo-button');
        const photoUploadInput = document.getElementById('photo-upload');
        if (changePhotoButton && photoUploadInput) {
            changePhotoButton.addEventListener('click', function () {
                photoUploadInput.click();
            });

            photoUploadInput.addEventListener('change', function () {
                if (this.files && this.files[0]) {
                    const formData = new FormData();
                    formData.append('new_picture', this.files[0]);

                    fetch(`/chats/${chatId}/change_picture`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${access_token}`
                        },
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'picture updated') {
                                const newSrc = `/chat/picture/${chatId}?${new Date().getTime()}`;

                                // Обновляем фото в "шторке"
                                const chatImage = document.getElementById('chatImage');
                                chatImage.setAttribute('src', newSrc);

                                // Обновляем фото в контейнере с названием чата
                                const interlocutorImage = document.querySelector('.interlocutor-info img');
                                if (interlocutorImage) {
                                    interlocutorImage.setAttribute('src', newSrc);
                                }

                                // Обновляем фото в левой панели
                                const chatItemInLeftPanel = document.querySelector(`.clickable-chat[data-chat-id="${chatId}"] .profile-picture`);
                                if (chatItemInLeftPanel) {
                                    chatItemInLeftPanel.setAttribute('src', newSrc);
                                }
                            }
                        })
                        .catch(error => console.error('Error:', error));
                }
            });
        }

        // Код для управления "шторкой"
        const interlocutorInfo = document.querySelector('.interlocutor-info');
        if (interlocutorInfo) {
            interlocutorInfo.addEventListener('click', function () {
                const drawer = document.querySelector('.drawer');
                drawer.classList.toggle('open');
            });
        }
    }


    function addOption() {
        const newOption = document.createElement('input');
        newOption.type = 'text';
        newOption.name = 'options';
        newOption.placeholder = 'New poll option';
        document.getElementById('poll-options').appendChild(newOption);
    }

    function createPoll() {
        const question = document.getElementById("poll-question").value;
        const optionsNodes = document.getElementsByName("options");
        const options = Array.from(optionsNodes).map(node => node.value);
        if (question === '' || options.some(option => option === '')) {
            alert('Вопрос и варианты ответа не должны быть пустыми.');
            return;
        }
        const pollData = {
            "action": "create_poll",
            "question": question,
            "options": options,
            "creator_phone_number": "{{ current_user.phone_number }}"
        };
        ws.send(JSON.stringify(pollData));
    }


    // Инициализация кода для create_chat.html
    function initializeCreateChatJS() {
        console.log("initializeCreateChatJS is called"); // Отладка
        const createChatForm = document.querySelector('form[action="/create_chat"]');
        if (createChatForm) {
            createChatForm.addEventListener('submit', function (event) {
                event.preventDefault();
                const formData = new FormData(createChatForm);
                fetch('/create_chat', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'created' && data.chat_id) {
                            fetch(`/chat/${data.chat_id}`)
                                .then(response => response.text())
                                .then(html => {
                                    document.querySelector('.right-panel').innerHTML = html;
                                    initializeChatJS(data.chat_id);
                                })
                                .catch(error => {
                                    console.error('Ошибка:', error);
                                });
                        } else {
                            console.log('Ошибка при создании чата:', data.error || "Unknown error");
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при отправке формы:', error);
                    });
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Загрузка формы создания чата
        const createChatLink = document.querySelector('.create-chat-link');
        if (createChatLink) {
            createChatLink.addEventListener('click', function (event) {
                event.preventDefault();
                fetch('/create_chat')
                    .then(response => response.text())
                    .then(html => {
                        document.querySelector('.right-panel').innerHTML = html;
                        initializeCreateChatJS();  // Важно: инициализация скриптов для новой формы
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                    });
            });
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>