<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ chat.chat_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #ECE5DD;
            font-family: Times New Roman, sans-serif;
        }
        .container {
            height: 100%;
        }
        #messages-container {
            height: calc(70vh - 100px);
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            background-color: #ce8334;
        }
        .message-item {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 10px;
        }
        .message-item.user {
            justify-content: flex-end;
        }
        .message-item .message-content {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 10px;
        }
        .message-item.user .message-content {
            background-color: #4CAF50;
            color: white;
        }
        /* Закрепляем поле ввода сообщения в подвале */
    #message-form-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #fff;
        padding: 10px;
        border-top: 1px solid #ccc;
    }
</style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="bg-white rounded p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h1>{{ chat.chat_name }}</h1>
                <div>
                    <a href="/home" class="btn btn-secondary">Вернуться назад</a>
                    <a href="/chat/{{ chat.id }}/members" id="member-count" class="btn btn-info">{{ members|length }} участников</a>
                </div>
            </div>
        </div>

        <!-- Chat actions -->
        <div class="my-2">
            {% if chat.owner_phone_number == current_user.phone_number %}
                <a href="/chat/{{ chat.id }}/members/add" class="btn btn-primary">Пригласить</a>
                <form action="/chats/{{chat.id}}/delete" method="post" class="d-inline">
                    <button type="submit" class="btn btn-danger">Удалить чат</button>
                </form>
            {% else %}
                <form action="/chats/{{chat.id}}/leave" method="post" class="d-inline">
                    <button type="submit" class="btn btn-warning">Покинуть чат</button>
                </form>
            {% endif %}
        </div>

<div id="messages-container" class="bg-white rounded p-3">
    <ul class="messages-list" id="chat-history">
        {% for message in messages %}
            <div class="message-item {% if message.sender_phone_number == current_user.phone_number %}user{% endif %}">
                {% if message.sender_phone_number == "deleted" %}
                    <h4>Deleted message</h4>
                {% else %}
                    <h4>{{ message.sender_nickname }}</h4>
                {% endif %}
                <div class="message-content">
                    <p>
                        {% if '[[FILE]]' in message.message and '[[/FILE]]' in message.message %}
                            {% set raw_message = message.message.split('[[FILE]]') %}
                            {{ raw_message[0] }}
                            {% set file_info = raw_message[1].replace('[[/FILE]]', '') %}
                            {% set file_id_info, file_name_info = file_info.split(', ') %}
                            {% set file_id = file_id_info.split(': ')[1] %}
                            {% set file_name = file_name_info.split(': ')[1] %}
                            <a href="/files/{{ file_id.split(': ')[1] }}">{{ file_name }}</a>
                        {% else %}
                            {{ message.message }}
                        {% endif %}
                    </p>
                    <small>Отправлено: {{ message.timestamp }}</small>
                </div>
                {% if message.sender_phone_number != "deleted" and (message.sender_phone_number ==
                current_user.phone_number or chat.owner_phone_number == current_user.phone_number) %}
                    <form action="/chats/{{ chat.id }}/messages/{{ message.id }}/delete" method="post">
                        <button type="submit">Delete message</button>
                    </form>
                {% endif %}
            </div>
        {% endfor %}
        </ul>
    </div>
    <!-- Добавленная секция для отображения опросов -->
{% for poll in polls %}
    <div id="poll-{{ poll.id }}" class="poll card">
        <div class="card-header">
            Опрос: {{ poll.question }}
        </div>
        <div class="card-body">
            {% if poll.user_voted %}
                <ul class="list-group">
                    {% for option_id, option in poll.options.items() %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ option }}
                            <span class="badge badge-primary badge-pill">{{ poll_results[poll.id][option_id][1]|round(2) }}% ({{ poll_results[poll.id][option_id][0] }} голосов)</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <form action="/chats/{{ chat.id }}/polls/{{ poll.id }}/vote" method="post">
                    {% for option_id, option in poll.options.items() %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="option_id" id="option-{{ option_id }}" value="{{ option_id }}">
                            <label class="form-check-label" for="option-{{ option_id }}">
                                {{ option }}
                            </label>
                        </div>
                    {% endfor %}
                    <!-- Добавление скрытого поля для номера телефона голосующего -->
                    <input type="hidden" name="voter_phone_number" value="{{ current_user.phone_number }}">
                    <button type="submit" class="btn btn-primary">Проголосовать</button>
                </form>
            {% endif %}
        </div>
    </div>
{% endfor %}
<!-- Конец добавленной секции -->


    <div id="message-form-container">
            {% if chat.id in left_chats %}
            <form action="/chats/{{ chat.id }}/return" method="post">
                <button type="submit">Return to chat</button>
            </form>
            {% else %}
            <form action="/chats/{{ chat.id }}/send_message" method="post" enctype="multipart/form-data">
                <label for="message-input">Сообщение:</label>
                <input type="text" id="message-input" name="message_text" for="message-input"><br>
                <label for="file-input">Файл:</label>
                <input type="file" id="file-input" name="file" for="file-input"><br>
                <input type="hidden" name="sender_phone_number" value="{{ current_user.phone_number }}">
                <button type="submit">Отправить</button>
            </form>


            <!-- Poll creation form -->
            <button onclick="document.getElementById('poll-form').style.display='block'">Создать опрос</button>
            <div id="poll-form" style="display: none;">
                <input type="hidden" name="creator_phone_number" value="{{ current_user.phone_number }}">
                <label for="poll-question">Вопрос:</label>
                <input type="text" id="poll-question" name="question"><br>
                <div id="poll-options">
                    <label for="pollInput">Варианты ответа:</label>
                    <input type="text" id="pollInput" name="options"><br>
                </div>
                <button type="button" onclick="addOption()">Добавить вариант ответа</button>
                <button type="button" onclick="createPoll()">Создать</button>
            </div>
            {% endif %}
    </div>
</div>
<script>
var chatId = "{{ chat.id }}";
const cookie = document.cookie.split('; ').find(row => row.startsWith('access_token='));
const access_token = cookie ? cookie.split('=')[1] : null;
var ws = new WebSocket(`ws://127.0.0.1:8000/ws/chats/${chatId}/`);

ws.onopen = function(event) {
    console.log("WebSocket connection opened.", event);
    ws.send(JSON.stringify({"action": "init_connection", "chat_id": chatId, "access_token": access_token}));
};

ws.onclose = function(event) {
    console.log("WebSocket connection closed:", event);
};

ws.onerror = function(error) {
    console.log(`WebSocket Error: ${error}`);
};

ws.onmessage = function(event) {
    const messageData = JSON.parse(event.data);
    const action = messageData.action;

    if (action === 'new_token') {
        document.cookie = "access_token=" + messageData.token;
    } else if (action === 'update_member_count') {
        console.log("Received update_member_count:", messageData.count);
        document.getElementById('member-count').textContent = messageData.count + " участников";
    } else {
        if (messageData.message && messageData.sender_phone_number) {
            const messagesList = document.getElementById('chat-history');
            const newMessage = document.createElement('div');
            newMessage.className = "message-item";  // Задаем базовый класс

            // Добавляем класс .user, если сообщение от текущего пользователя
            if (messageData.sender_phone_number === "{{ current_user.phone_number }}") {
                newMessage.className += " user";
            }

            const senderElement = document.createElement("h4");
            senderElement.innerText = messageData.sender_phone_number || "Unknown";
            newMessage.appendChild(senderElement);

            console.log(messageData.message);
            const rawMessage = messageData.message;

            if (rawMessage.includes('[[FILE]]') && rawMessage.includes('[[/FILE]]')) {
                const [messageText, fileInfo] = rawMessage.split('[[FILE]]');
                const cleanFileInfo = fileInfo.replace('[[/FILE]]', '');
                const [fileIdInfo, fileNameInfo] = cleanFileInfo.split(', ');
                const fileId = fileIdInfo.split(': ')[1];
                const fileName = fileNameInfo.split(': ')[1];

                if (fileId && fileName) {
                    newMessage.innerHTML += `${messageText} <a href="/files/${fileId}">${fileName}</a><br>`;
                }
            } else {
                newMessage.innerHTML += `${rawMessage}<br>`;
            }

            const timeElement = document.createElement("small");
            timeElement.innerText = "Отправлено: " + (messageData.timestamp || "undefined");
            newMessage.appendChild(timeElement);

            messagesList.appendChild(newMessage);

            // Автоматически прокручиваем чат вниз
            setTimeout(() => {
                messagesList.scrollTop = messagesList.scrollHeight;
            }, 0);
        } else {
            console.warn('Неожиданный формат сообщения: ', messageData);
        }
    }
};


function addOption() {
    const newOption = document.createElement('input');
    newOption.type = 'text';
    newOption.name = 'options';
    newOption.placeholder = 'New poll option';
    document.getElementById('poll-options').appendChild(newOption);
}

function createPoll() {
    const question = document.getElementById("poll-question").value;
    const optionsNodes = document.getElementsByName("options");
    const options = Array.from(optionsNodes).map(node => node.value);
    if (question === '' || options.some(option => option === '')) {
        alert('Вопрос и варианты ответа не должны быть пустыми.');
        return;
    }
    const pollData = {
        "action": "create_poll",
        "question": question,
        "options": options,
        "creator_phone_number": "{{ current_user.phone_number }}"
    };
    ws.send(JSON.stringify(pollData));
}
</script>
</body>
</html>
